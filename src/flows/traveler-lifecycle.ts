import type { FlowDefinition } from './types';

export const travelerLifecycle: FlowDefinition = {
  id: 'traveler-lifecycle',
  label: 'Renter Journey',
  description: 'End-to-end lifecycle from browsing to check-in. Renters can book directly, bid on listings, or post travel requests for owners to propose against.',
  primaryRole: 'renter',
  roleEmoji: 'ðŸ§³',
  direction: 'TD',
  steps: [
    {
      id: 'browse',
      route: '/',
      label: 'Browse Landing',
      component: 'Index',
      nodeStyle: 'start',
      description: 'Renter discovers the marketplace via landing page',
    },
    {
      id: 'signup',
      route: '/signup',
      label: 'Sign Up',
      component: 'Signup',
      description: 'Create account with email or Google OAuth',
      tables: ['profiles', 'user_roles'],
    },
    {
      id: 'pending_approval',
      route: '/pending-approval',
      label: 'Await Approval',
      component: 'PendingApproval',
      nodeStyle: 'decision',
      tables: ['profiles'],
      branches: [
        { condition: 'Approved', targetStepId: 'search_listings', label: 'Approved' },
      ],
    },
    {
      id: 'search_listings',
      route: '/rentals',
      label: 'Search Listings',
      component: 'Rentals',
      description: 'Browse, filter, and search active listings',
      tables: ['listings', 'properties'],
      branches: [
        { condition: 'Found listing', targetStepId: 'view_property', label: 'View listing' },
        { condition: 'Post travel request', targetStepId: 'post_travel_request', label: 'Request vacation' },
      ],
    },
    {
      id: 'view_property',
      route: '/property/:id',
      label: 'View Property',
      component: 'PropertyDetail',
      description: 'View listing details, photos, amenities, pricing. Owner decides at listing time whether bidding is open.',
      tables: ['listings', 'properties'],
      branches: [
        { condition: 'Listing allows direct booking', targetStepId: 'checkout', label: 'Book directly' },
        { condition: 'Listing is open to bidding', targetStepId: 'place_bid', label: 'Place bid' },
      ],
    },
    {
      id: 'place_bid',
      route: '/property/:id',
      label: 'Place Bid',
      component: 'BidFormDialog',
      description: 'Submit a bid offer on a biddable listing (owner opted in at listing time)',
      tables: ['listing_bids', 'notifications'],
      branches: [
        { condition: 'Bid accepted', targetStepId: 'checkout', label: 'Accepted â†’ Pay' },
        { condition: 'Counter-offer', targetStepId: 'place_bid', label: 'Counter', edgeStyle: 'dashed' },
        { condition: 'Rejected', targetStepId: 'search_listings', label: 'Rejected', edgeStyle: 'dashed' },
      ],
    },
    {
      id: 'post_travel_request',
      route: '/bidding',
      label: 'Post Travel Request',
      component: 'TravelRequestForm',
      description: 'Renter posts a reverse-auction request specifying destination, dates, budget â€” owners respond with proposals',
      tables: ['travel_requests'],
      branches: [
        { condition: 'Proposal received', targetStepId: 'review_proposals', label: 'Proposals in' },
      ],
    },
    {
      id: 'review_proposals',
      route: '/my-bids',
      label: 'Review Proposals',
      component: 'MyBidsDashboard',
      description: 'Review owner proposals on travel request and accept or reject',
      tables: ['travel_proposals'],
      branches: [
        { condition: 'Accept proposal', targetStepId: 'checkout', label: 'Accept â†’ Pay' },
        { condition: 'Reject all', targetStepId: 'search_listings', label: 'Reject all', edgeStyle: 'dashed' },
      ],
    },
    {
      id: 'checkout',
      route: '/checkout',
      label: 'Stripe Checkout',
      component: 'Checkout',
      nodeStyle: 'external',
      description: 'Secure payment via Stripe Checkout â€” full payment captured at booking',
      edgeFunctions: ['create-booking-checkout'],
      tables: ['bookings'],
    },
    {
      id: 'booking_success',
      route: '/booking-success',
      label: 'Booking Confirmed',
      component: 'BookingSuccess',
      description: 'Payment confirmed, reservation details shown, funds held in escrow',
      edgeFunctions: ['verify-booking-payment'],
      tables: ['bookings', 'booking_confirmations'],
    },
    {
      id: 'awaiting_owner_confirmation',
      route: '/booking-success',
      label: 'Awaiting Owner Confirmation',
      component: 'BookingSuccess',
      description: 'Owner has a configurable time window to confirm they can fulfill the booking. Extensions may be requested.',
      tables: ['booking_confirmations'],
      branches: [
        { condition: 'Owner confirms', targetStepId: 'checkin', label: 'Confirmed' },
        { condition: 'Owner declines/times out', targetStepId: 'search_listings', label: 'Refunded', edgeStyle: 'dashed' },
      ],
    },
    {
      id: 'checkin',
      route: '/checkin',
      label: 'Check In',
      component: 'TravelerCheckin',
      nodeStyle: 'decision',
      description: 'Confirm arrival or report issues at the property',
      tables: ['checkin_confirmations'],
      branches: [
        { condition: 'All good', targetStepId: 'stay_complete', label: 'Confirmed' },
        { condition: 'Issue reported', targetStepId: 'issue_resolution', label: 'Issue' },
      ],
    },
    {
      id: 'contact_support',
      route: '/contact',
      label: 'Contact Support',
      component: 'Contact',
      description: 'Submit a support inquiry via contact form. Sends email notification to support team and confirmation to user.',
      edgeFunctions: ['send-contact-form'],
    },
    {
      id: 'issue_resolution',
      route: '/admin',
      label: 'Issue Resolution',
      component: 'AdminCheckinIssues',
      roles: ['rav_admin'],
      description: 'RAV team resolves reported check-in issues',
      tables: ['checkin_confirmations'],
    },
    {
      id: 'stay_complete',
      route: '/',
      label: 'Stay Complete',
      component: 'Index',
      nodeStyle: 'end',
      description: 'Trip completed successfully, payout released to owner',
    },
  ],
};
